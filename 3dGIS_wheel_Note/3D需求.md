# 3D 功能

## 1.指标录入查询与分析
### 1.1 地交叠检查
设图层$A$与图层$B$部分重叠，重叠区取为图层$C$:
$$C=A \bigcap B$$
假定从$A$中擦除掉$C$的部分（则此地分配给$B$）:
$$A=A \bigcap  \overline C$$
或从$B$中擦除掉$C$的部分（则此地分配给$A$）:
$$B=B \bigcap  \overline C$$

实际用地图层$R$与规划用地图层$P$之间溢出部分：
$$\overline P \bigcap R$$

---

### 1.2 日照间距控制
$$\tan h=\frac{H-H_{1}}{D}$$
$$D=\frac{H-H_1}{\tan h}$$

$H_1$为后幢房屋窗台至地面高度

若日照系数$\frac{D}{H-H_1}$小于规定日照系数，则不满足间距。<br>
若是目标建筑附近有多个建筑，需要都对其遮挡效果进行计算。

![distance](https://gss2.bdstatic.com/-fo3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike92%2C5%2C5%2C92%2C30/sign=a3161ba143166d222c7a1dc6274a6292/35a85edf8db1cb13bfb9a079dd54564e93584b8c.jpg)

**太阳高度角**$h$（某地太阳光线与该地作垂直于地表切线的夹角）的计算：
$$\sin h=\sin \phi \sin E_{D} + \cos \phi \cos \tau \cos E_{D}$$
$\phi$为地理纬度 $E_{D}$为太阳赤纬角 $\tau$为当时的太阳时角
$$\tau=(S_o+F_o/60-12) * 15°$$
$S_o$代表小时，$F_o$代表分钟

PS:由于点光源（太阳）距离分析目标（建筑群）较远，所以对于它们可以看作平行光源

```cpp
float SolarDirectionCalc::GetLatOfSun(){
    //jiri函数是计算太阳积日，即当前时间在一年中所经过的天数
    float t=jiri(year,month,day)-79.6764-0.2422*(year-1985)+floor((year-1985)/4.0);
    float sita=2*PI*t/365.2422;
    float delta=0.3723+23.2567*sin(sita)+0.1149*sin(2*sita)-0.1712*sin(3*sita)-0.758*cos(sita)+0.3656*cos(2*sita)+0.0201*cos(3*sita);
    return delta;
}
```


---

### 1.3 建筑最小间距计算
建筑最小间距即此范围内可以满足日照系数控制的最小间距。

---

### 1.4 公共绿地面积检测
>> for TIN

设任一三角形三个顶点$A,B,C$三点坐标分别为$(x_A,y_A,z_A)$，$(x_B,y_B,z_B)$和$(x_C,y_C,z_C)$

三边分别为$a$,$b$,$c$<br>
$$a=\sqrt{(x_B-x_C)^2+(y_B-y_C)^2+(z_B-z_C)^2}$$
$$b=\sqrt{(x_A-x_C)^2+(y_A-y_C)^2+(z_A-z_C)^2}$$
$$c=\sqrt{(x_B-x_A)^2+(y_B-y_A)^2+(z_B-z_A)^2}$$

三角形面积依据海伦公式
$$S=\sqrt{p(p-a)(p-b)(p-c)}$$
$$p=\frac12(a+b+c)$$

Delaunay三角网表面积为区域内所有三角形之和：$$S_{表面积}=\sum_{i=1}^{n}S_i$$

---

### 1.5 土方量计算
>> for DEM 

进行栅格计算，用原始高程DEM减去设计高程DEM<br>
利用邻域分析模块进行田块编号与挖填土方量的联结

>> for TIN（DEM的一种表达模型）

使用不规则三角网通过与平面叠加的方式来计算每个三棱柱的体积，累加得到填方区域和挖方区域分界面。

三棱柱上表面通常采用斜面或者平面拟合，下表面均为水平面或参考面
$$V_3=\frac{Z_1+Z_2+Z_3}{3 \cdot S_3}$$
$Z_1$,$Z_2$,$Z_3$为三角形角点填挖高差 $S_3$为三棱柱底面积

---

## 2.地形分析 


| 名称 | 定义 | 方法 |
| ------ | ------ | ------ |
| 山顶点peak | 在局部区域内海拔高程的极大值点，表现为在各方向上都为凸起 | $H_{\max}=H_{i}$即i点为山顶点 |
| 凹陷点pit | 局部区域内海拔高程的极小值点，表现为在各方向上都为凹陷 | $H_{\min}=H_{i}$即i点为凹陷点 |
| 鞍部点pass | 在两个相互正交的方向上，一个方向凸起，而另一个方向凹陷的点 | 山脊线中的最低点 |
| 山脊线山谷线 |   | 设计一个n×n窗口以对DEM格网阵列进行扫描；<br>第一次扫描中，将窗口中的具有最低高程值的点进行标记，自始至终未被标记的点即为山脊线上的点；<br>第二次扫描中，将窗口中的具有最高高程值的点进行标记，自始至终未被标记的点即为山谷线上的点<br> [more](https://blog.csdn.net/summer_dew/article/details/82967666) |
| 沟沿线 |   | DEM->求Slope->求Slope<br>  [more](https://blog.csdn.net/summer_dew/article/details/82969099) |

---

## 3.道路设计 
要确定好线路的基本走向，再根据城市房屋建筑的位置，对建筑物拆除分析，以及对周围花草树木的破坏性分析后，再对线路走向和坡度进行选择。

---

## 4.通用的数据分析 
### 4.1 空间量算
**距离量算**(可表示为点对坐标的序列)：$$L=\sum_{i=0}^{n-1}[(x_{i+1}-x_{i})^2+(y_{i+1}-y_i)^2+(z_{i+1}-z_{i})]^{1/2}=\sum_{i=1}^{n}l_i$$
**面积量算**(但连通多边形在水平面上投影面积的量算):$$S_{A_1A_2 \cdots A_n}=abs(S_{△(P,A_1,A_2)}+S_{△(P,A_2,A_3)}+ \cdots +S_{△(P,A_n,A_2)})$$
**体积量算**：$$V=S_{A_1A_2 \cdots A_n} × h$$

---

**地面上两点距离测算**

得到$A$,$B$的坐标分别为$(x_a,y_a,z_a)$和$(z_b,y_b,z_b)$

计算$AB$间真实距离的过程为：<br>
a.根据A、B两点的水平座标，计算线段$AB$在水平面的投影直线方程（假设$x_a \leq b_b$）
$$y=\frac{y_b-y_a}{x_b-x_a} × (x-x_a) +y_a \ \ \ \ (x_a \leq x \leq x_b)$$
b.计算在投影平面上线段$AB$与网格的所有交点，并按$x$轴坐标的升序进行排列。保存交点与所对应的临近网格点的信息。比如通过计算得到$DE$所在水平线与线段$AB$的交点为$C$，在程序中记录$C$的水平面坐标$(x_c,y_c)$及对应的临近点$D、E$；<br>
c.基于临近点的高程值，对一系列的交点进行线性插值计算，获得交点的高程。<br>
d.对线段$AB$上的所有点序列累计计算相邻两点之间的三维距离

---

![1](https://github.com/makixi/LearningNote/blob/master/3dGIS_wheel_Note/s_skin.png?raw=true)

**地形表面积的测量：**<br>
a.将网格的各点用逆时针表示。网格可表示为$(P_1,P_2,P_3,P_4)$，在此一定要保证点的顺序，不能交叉存放。<br>
b.利用射线法判断各点是否均在多边形的内部或外部，如果各点均在多边形的外部，则表面积为0；如果各点均在多边形的内部，则将网格分为两个空间三角形$△(P_1,P_2,P_3)$和$△(P_1,P_3,P_4)$,分别计算三角形的面积求和，否则进行下一步。<br>
c.分别计算边$P_1P_2$、$P_2P_3$、$P_3P_4$、$P_4P_1$与多边形边的交点，如上图所示可得与边$P_1P_2$有交点$M$，与边$P_3P_4$有交点$N$。将交点加入到原来的网格点序列中，网格表示为$(P_1,M,P_2,P_3,N,P_4)$，去掉序列中在多边形以外的顶点。假设点$P_1$、$P_4$在多边形的外部，则序列变为$(M,P_2,P_3,N)$。判断该网格内知否包含多边形顶点，如果有顶点，则绕顶点将以上生成的顶点序列拆分为多个三角面进行面积的累计计算，否则直接将顶点序列进行拆分计算。



### 4.2 叠加分析
**点与多边形叠合**：判断点包含在哪一个多边形中，从而为点设置新的多边形属性。<br>
**线与多边形的叠合**：判断线包含在哪一个多边形里面，从而为线设置新的多边形属性。<br>
**多边形与多边形叠合**：合并、相交、一致、相减、更新。

---

### 坡度坡面分析
**坡面因子**<br>
地表面任一点的坡度是指过该点的切平面与水平地面的夹角。<br>
数值上等于过该点的地表微分单元的法矢量与$z$轴的夹角。

$$Slope=\arctan \sqrt{f_x^2+f_y^2} × 180 / \pi$$
$f_x$是$x$方向高程变化率，$f_y$是$y$方向高程变化率

---

**坡向**：表示表面某处最陡的倾斜方向。

对TIN表面的每个三角面或栅格图像的每一个像元进行计算。

---

**坡形**：局部地表坡面的曲折状态。

**地面曲率因子**：对地形表面点的扭曲变化程度的定量化度量因子，地面曲率在垂直和水平两个方向上的分量分别称为**平面曲率**（地面上任一点位地表坡向的变化率）和**剖面曲率**（地面上任一点位地表坡度的变化率）

平面曲率(即正切曲率)：$$K_h=-\frac{q^2r-2pqs+p^2t}{(p^2+q^2)\sqrt{1+p^2+q^2}}$$
剖面曲率：$$K_v=-\frac{p^2r+2pqs+q^2t}{(p^2+q^2)(1+p^2+q^2)^{3/2}}$$

其中，<br>
$p=\frac{\partial z}{\partial x}$，是$x$方向高程变化率<br>
$q=\frac{\partial z}{\partial y}$，是$y$方向高程变化率<br>
$r=\frac{\partial^2 z}{\partial x^2}$，是$x$方向高程变化率的变化率<br>
$s=\frac{\partial^2 z}{\partial xy}$，是$x$方向高程变化率在$y$方向的变化率<br>
$t=\frac{\partial^2 z}{\partial y^2}$，是$y$方向高程变化率的变化率<br>

$K_h>0$表明物质在此处分流，该点靠近**山脊**部；<br>
$K_h<0$表明物质在此处汇聚，该点靠近**山谷**部。

---

**坡长**：通常指地面上一点沿水流方向到其流向起点间的最大地面距离在水平面上的投影长度。
$$L=m × \cos \theta$$
$L$为坡长，$m$指地表面沿流向的水流长度，$\theta$指水流地区的地面坡度值。

累计坡长计算 $\lambda_{i,j}=\sum_{x=0,y=0}^{x=i,y=j}\sum_{k=1}^{m} \lambda_{x,y}$

```bash
while(被改变点 count>0){
        //正向搜索
        for(row=0;row<行数;row++)
            for(col=0;col<列数;col++){
                c=row*列数+col;
                if(c点位无值点)
                    continue;
                设置初始坡长度 initlen=0;
                寻找相邻8个可能流入的最大的坡长 maxlen;
                if(c点累积坡长值<initlen+c点坡长){
                    c点累积坡长值=initlen+c点坡长;
                    count++;
                }
            }
        //反向搜索
        for(row=行数-1;row>=0;row--)
            for(col=列数-1;col>=0;col--){
                c=row*列数+col;
                if(c点位无值点)
                    continue;
                设置初始坡长度 initlen=0;
                寻找相邻8个可能流入的最大的坡长 maxlen;
                if(c点累积坡长值<initlen+c点坡长){
                    c点累积坡长值=initlen+c点坡长;
                    count++;
                }
            }
    }
```

---

**坡面复杂度因子**

地形起伏度：是在指定区域内最大高程与最小高程的差
$$RF_i=H_{\max}-H_{\min}$$

地表切割深度：指地面某点的邻域范围的平均高程与该邻域范围内的最小高程的差值。
$$D_i=H_{mean}-H_{\min}$$

地表粗糙度：反应地表的起伏变化和侵蚀程度的指标，一般定义为地表单元的曲面面积与其其在水平面上的投影面积之比
$$R=S_{曲面}/S_{水平}\ \ \ \ R=1/\cos(S)$$



---

## 5.规划统计分析工具 

### 通视分析 
PS:此下未考虑地球曲率

$p_1(x_1,y_1,z_1)$,$p_2(x_2,y_2,z_2)$，得到空间直线$p_1p_2$以及$p_1p_2$在水平面上的投影直线$p_1^{'}p_2^{'}$<br>
然后逐单元计算平面直线$p_1^{'}p_2^{'}$与DEM网格边的所有交点并依次内插其高程。判断所有交点的高程，只要有一个点的高程位于空间直线$p_1p_2$之上，则认为$p_1p_2$两点之间不通视；反之则通视

![1](https://github.com/makixi/LearningNote/blob/master/3dGIS_wheel_Note/view.png?raw=true)

>>考虑地物因素

首先挑选出与该线段相交的地物包围盒集合。<br>
然后，在此集合中遍历每个地物的三角面片，判断是否与该线段相交，如果有发生了一次相交，则退出计算过程，分析结果为不通视，否则结果为通视。

### 日照分析

### 水淹分析

### 视域分析